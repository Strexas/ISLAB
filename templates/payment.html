<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Payment Portal | Bolt Drive</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      :root {
        --primary: #0d6efd;
        --bg: #f0f2f5;
        --text: #1f2933;
        --success: #198754;
        --danger: #dc3545;
      }
      body {
        margin: 0;
        font-family: -apple-system, sans-serif;
        background: var(--bg);
        color: var(--text);
      }

      /* SUCCESS OVERLAY */
      #successOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }
      .success-box {
        background: white;
        padding: 40px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        animation: popIn 0.4s ease;
      }
      @keyframes popIn {
        from {
          transform: scale(0.8);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
      .checkmark {
        font-size: 60px;
        color: var(--success);
        display: block;
        margin-bottom: 10px;
      }

      /* LAYOUT STYLES */
      .topbar {
        background: #fff;
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        border-bottom: 1px solid #ddd;
      }
      .brand {
        font-size: 1.25rem;
        font-weight: bold;
        color: #16396b;
        text-decoration: none;
      }
      .main-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 24px;
        max-width: 1100px;
        margin: 30px auto;
        padding: 0 20px;
      }
      .card-section {
        background: white;
        border-radius: 10px;
        padding: 24px;
        margin-bottom: 24px;
        border: 1px solid #e1e4e8;
      }
      input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        margin-bottom: 10px;
        box-sizing: border-box;
      }
      .btn {
        padding: 10px;
        width: 100%;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        color: white;
        font-weight: bold;
      }
      .btn-primary {
        background: var(--primary);
      }
      .btn-danger {
        background: var(--danger);
        width: auto;
        padding: 5px 10px;
        font-size: 0.8rem;
      }
    </style>
  </head>
  <body>
    <div id="successOverlay">
      <div class="success-box">
        <span class="checkmark">âœ”</span>
        <h2>Payment Successful!</h2>
        <p>Your reservation is confirmed.</p>
        <p style="color: #777; font-size: 0.9rem">Redirecting to home...</p>
      </div>
    </div>

    <div class="topbar">
      <a href="/" class="brand">ðŸš— Bolt Drive</a>
      <a href="/" style="text-decoration: none; color: #16396b">Home</a>
    </div>

    <div class="main-grid">
      <div class="column-left">
        <div class="card-section">
          <h3>âž• Add New Bank Card</h3>
          <form action="{{ url_for('payment.add_bank_card') }}" method="post">
            <input type="hidden" name="user_id" value="{{ user.id }}" />
            <input
              type="text"
              name="cardholder_name"
              placeholder="Name on Card"
              required
            />
            <input
              type="text"
              name="card_number"
              placeholder="Card Number"
              required
            />
            <div style="display: flex; gap: 10px">
              <input
                type="text"
                name="expire_date"
                placeholder="YYYY-MM-DD"
                required
              />
              <input type="text" name="cvv" placeholder="CVV" required />
            </div>
            <input
              type="text"
              name="billing_address"
              placeholder="Billing Address"
              required
            />
            <button class="btn btn-primary">Save Securely</button>
          </form>
        </div>

        <div class="card-section">
          <h3>ðŸ’³ Saved Cards</h3>
          {% if cards %} {% for card in cards %}
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              background: #f9f9f9;
              padding: 10px;
              margin-bottom: 10px;
              border-radius: 5px;
            "
          >
            <span>**** **** **** {{ card.cardnumber[-4:] }}</span>
            <form
              action="{{ url_for('payment.delete_bank_card', card_id=card.cardid) }}"
              method="post"
              style="margin: 0"
            >
              <button class="btn btn-danger">Delete</button>
            </form>
          </div>
          {% endfor %} {% else %}
          <p style="color: #777">No cards saved.</p>
          {% endif %}
        </div>
      </div>

      <div class="column-right">
        <div
          class="card-section"
          style="background: #eef4ff; border-color: #dbeafe"
        >
          <h3 style="margin-top: 0">ðŸ’° Wallet Balance</h3>
          <h1 style="color: var(--primary)">
            â‚¬ {{ "%.2f"|format(wallet_balance) }}
          </h1>

          <form
            action="{{ url_for('payment.add_money') }}"
            method="post"
            style="display: flex; gap: 5px"
          >
            <input type="hidden" name="user_id" value="{{ user.id }}" />
            <input
              type="number"
              name="amount"
              placeholder="Amount â‚¬"
              step="0.01"
              required
              style="margin-bottom: 0"
            />
            <button class="btn btn-primary" style="width: auto">Top Up</button>
          </form>
        </div>

        <div class="card-section" style="border: 2px solid var(--primary)">
          <h3 style="color: var(--primary)">âœ… Pay for Reservation</h3>

          {% if reservation %}
          <p style="color: #666; font-size: 0.9rem">
            Payment for <strong>{{ display_res_id }}</strong>
          </p>

          <form
            id="payForm"
            method="post"
            action="{{ url_for('payment.pay_from_balance', total_amount=total_amount) }}"
          >
            <input type="hidden" name="user_id" value="{{ user.id }}" />

            <label>Reservation ID</label>
            <input
              type="text"
              name="reservation_id"
              value="{{ res_id }}"
              readonly
              style="background: #eee; font-weight: bold"
            />

            <label>Total Amount (â‚¬)</label>
            <input
              type="text"
              name="amount"
              value="{{ '%.2f'|format(total_amount) }}"
              readonly
              style="
                background: #eee;
                font-weight: bold;
                color: var(--primary);
                font-size: 1.1rem;
              "
            />

            <label>Description</label>
            <input
              type="text"
              name="description"
              value="Rental + {{ 'Insurance' if insurance_cost > 0 else 'No Insurance' }}"
            />

            <button
              type="submit"
              class="btn btn-primary"
              style="margin-top: 10px"
            >
              Pay from Balance
            </button>
          </form>
          {% else %}
          <div style="color: red">
            Error: No reservation loaded. Please go back to fleet page.
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <script>
      document
        .getElementById("payForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const formData = new FormData(this);
          const jsonData = Object.fromEntries(formData.entries());

          fetch("{{ url_for('payment.pay_from_balance') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(jsonData),
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                // POPUP GÃ–STER
                document.getElementById("successOverlay").style.display =
                  "flex";
                // 2.5 sn Sonra YÃ¶nlendir
                setTimeout(() => {
                  window.location.href = "/";
                }, 2500);
              } else {
                alert("Hata: " + data.message);
              }
            })
            .catch((err) => {
              console.error(err);
              alert("Sunucu hatasÄ± oluÅŸtu. Konsolu kontrol edin.");
            });
        });
    </script>
  </body>
</html>
